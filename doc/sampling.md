# 샘플링 프로세스 개요

프로세스 내부 구현은 큰 이슈가 아니며, 설계상 핵심은 프로세스 간 통신 시 어느 데이터를 언제 전송할지 결정하는 것임.

프로젝트에서 데이터 처리 방식은 각 워커에서 로컬 정렬을 수행한 후, 구간별로 사전에 지정된 워커에게 데이터를 전송하고, 다시 로컬 정렬을 통해 전체 정렬을 완성하는 구조임.

특히 워커별 담당 구간을 정하기 위한 샘플링 과정이 첫 번째 핵심 통신 단계로, 초기 워커 등록 이후 수행됨.

정렬할 데이터는 `gensort`로 생성되며, 키 값 범위는 기본적으로 0x00000000000000000000부터 0xFFFFFFFFFFFFFFFFFFFF까지 균일 분포를 가정함.  
샘플링의 목표는 전체 데이터의 n분위수 추정이며, 각 워커별 구간 할당에 활용됨.

샘플링 알고리즘의 선택에 따라 첫 로컬 정렬에서 데이터를 활용하는 방향이 변화함.
샘플링 결과가 운에 의해 정확도가 낮을 경우, 일부 워커에 데이터가 쏠리게 되며, 이로 인해 통신 성능과 로컬 정렬 성능이 모두 감소함.  
다시 말해 워커 간 균형이 깨지면서 분산 정렬의 효율이 급감함.  
특히 데이터 양이 매우 많아 워커별 디스크 용량을 초과할 경우, 분산 정렬 자체가 실패할 수 있음.

따라서 설계 과정에서 샘플링 알고리즘 선택과 구간 추정 방법이 중요한 의사결정 요소임.

<br>

## 단순 랜덤 추출 (Simple Random Sampling, SRS)

단순 랜덤 추출은 모집단의 각 데이터가 동일한 확률로 선택되는 가장 기본적인 샘플링 기법임.  
총 n개의 데이터를 k개의 워커에서 추출할 때, 각 워커는 정렬 전에 n/k개의 데이터를 무작위로 뽑아 master(혹은 server)로 전송하면 됨.

단순 랜덤 추출에서 표본평균의 분산은 다음과 같이 표현됨.

$$
Var(\bar{X}_{SRS}) = \frac{\sigma^2}{n} \left( 1 - \frac{n}{N} \right)
$$

샘플링 횟수가 낮을 경우, 특히 단순 랜덤 추출은 n분위수 추정 정확도에 대한 기대가 떨어질 수 있음.

<br>

## 층화 추출 (Stratified Sampling, STS)

층화 추출은 모집단을 여러 개의 층(Strata)으로 나눈 뒤, 각 층에서 무작위로 샘플을 추출하는 방법임.  
모집단의 이질성이 큰 경우, 층화 추출을 사용하면 각 층의 특성을 반영하여 전체 표본 추정치의 분산을 줄일 수 있음.

총 n개의 데이터를 k개의 워커에서 처리할 때, 각 워커는 전체 구역을 k등분하여 각 구역에 해당하는 데이터의 수$N_h$ 를 세고, 그 비율에 맞게 $n_h$개의 샘플을 추출하여 master로 전송하면 됨.

층화 추출에서 표본평균의 분산은 다음과 같이 표현됨.

$$
Var(\bar{X}_{ST}) = \sum_{h=1}^{L} W_h^2 \frac{\sigma_h^2}{n_h} \left( 1 - \frac{n_h}{N_h} \right)
$$
(대충 SRS보다 작다는 뜻)

샘플링 횟수가 낮을 경우에도, 층화 추출은 각 층별 특성을 반영하므로 단순 랜덤 추출보다 상대적으로 n분위수 추정 정확도가 높음.  

참고로, 데이터가 거의 균일분포로 생성되는 경우에는 층화 추출의 효율이 단순 랜덤 추출과 거의 동일함.  
하지만 프로젝트에서는 항상 데이터가 전체 영역에서 온전히 균일하게 분포한다는 가정을 하지 않고 진행하는게 좋아보임.
(온전한 균일 분포임을 가정한다면, 샘플링 자체를 생략하고 전체 구역을 20등분해도 무방하니까...).

## 샘플링 구현상 비교

### 용어 정리
- $N$ : 전체 표본 수  
- $N/k$ : 한 워커가 가진 전체 표본 수  
- $n$ : 샘플링용 표본 수  
- $k$ : 워커 수

### 단순 랜덤 추출 (SRS)
1. 각 워커는 정렬 전에 그냥 $n/k$개의 샘플을 master로 전송하면 끝임.  
2. 각 워커는 master에게서 샘플링 결과를 받고, 정렬하면서 각 워커로 보낼 구간에 맞게 데이터를 정리한 뒤 다른 워커에게 전송하면 됨.

### 층화 추출 (STS)
1. 샘플링은 정렬 후에 수행함.  
2. 각 워커는 정렬하면서 전체 범위 $0\text{x}000\ldots00$ 부터 $0\text{x}FFF\ldots FF$까지를 총$k$개 구간으로 나누고, 각 구간에 몇 개의 데이터가 있는지($N_k$) 계산함.  
3. 각 워커는 $n/k$개의 샘플을, 각 $k$ 구간에서 $\frac{N_k}{N/k} \cdot n/k = N_k \cdot\frac{n}{N}$개씩 무작위로 추출하여 구성함.  
4. 각 워커는 master에게서 샘플링 결과를 받고, 해당 구간에 맞게 정렬된 데이터를 다시 정리한 뒤 다른 워커들에게 전송함.

### 추가 설명
샘플 구성 자체는 구현상 어렵지 않아 보이나, **디스크에 정렬된 데이터를 다시 정리하는 부분**에서 SRS와 STS 간 속도 및 구현 난이도 차이가 발생할 가능성이 있음.


## 결론

| 샘플링 방식 | 장점 | 주의점 |
|------------|------|--------|
| 층화 추출 (STS) | 샘플링 횟수 증가 없이 신뢰도 향상 | Disk I/O로 인한 처리 지연 증가 |
| 단순 랜덤 추출 (SRS) | 구현 단순, 샘플 구성 쉬움 | 샘플링 횟수 증가 필요 → Network I/O 부담 증가 |
